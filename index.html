<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Heads‑Up Poker — One‑Code Join</title>
  <style>
    :root { --bg:#08301d; --felt:#0d5c3a; --rail:#3b1f0f; --accent:#2bd576; --text:#f7fff9; --muted:#bfe8d1; --danger:#ff6b6b; --line:#145336; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;color:var(--text);background:radial-gradient(1200px 800px at 50% -20%, #116b44 0%, #08301d 60%, #062718 100%);} 
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:14px 18px;border-bottom:1px solid var(--line);background:rgba(0,0,0,.25);backdrop-filter: blur(6px);} 
    header h1{font-size:18px;margin:0;font-weight:800;letter-spacing:.3px}
    header .tag{font-size:12px;color:var(--muted)}

    main{display:grid;grid-template-columns:380px 1fr 320px;gap:14px;padding:14px}
    .card{background:rgba(0,0,0,.18);border:1px solid var(--line);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .section{padding:14px}
    .stack{display:flex;flex-direction:column;gap:10px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .row .grow{flex:1}
    input[type=text], input[type=number]{width:100%;background:#072d1b;color:var(--text);border:1px solid var(--line);border-radius:12px;padding:10px 12px}
    button{appearance:none;border:none;border-radius:12px;padding:12px 14px;font-weight:800;cursor:pointer;background:#0a3a22;color:var(--text);border:1px solid #166342;transition:transform .02s ease, background .2s ease}
    button.primary{background:linear-gradient(180deg,#30df89,#1dbf6e);color:#082016;border:none}
    button.warning{background:linear-gradient(180deg,#ffb199,#ff6b6b);color:#2a100f;border:none}
    button:active{transform:translateY(1px)}
    .pill{font-size:12px;background:#0b3a25;border:1px solid #1b6a46;color:var(--muted);padding:4px 8px;border-radius:999px}

    /* Table */
    .table{padding:16px;background:radial-gradient(900px 400px at 50% -80px, #17885a 0%, var(--felt) 50%, #0e5135 100%);border-top:2px solid #0a3a22;border-bottom-left-radius:16px;border-bottom-right-radius:16px;position:relative;overflow:hidden}
    .rim{position:absolute;inset:0;border:18px solid var(--rail);border-radius:28px;pointer-events:none;box-shadow:inset 0 0 0 2px #5a2f17, 0 20px 60px rgba(0,0,0,.35)}
    .pot{font-size:14px;color:#e5ffef;text-shadow:0 2px 8px rgba(0,0,0,.5);text-align:center;margin-bottom:8px}
    .board,.hand{display:flex;gap:12px;justify-content:center}

    /* Big playing cards */
    .card-ui{width:86px;height:118px;border-radius:12px;border:2px solid #e0f8ec;background:linear-gradient(145deg,#ffffff,#d9efe6);display:grid;place-items:center;font-weight:900;font-size:28px;color:#0a1820;box-shadow:0 8px 24px rgba(0,0,0,.35)}
    .card-ui.dim{opacity:.4}
    .hand .card-ui{background:linear-gradient(145deg,#ffffff,#eaf7f1)}
    .back{background:repeating-linear-gradient(45deg,#0a3a22,#0a3a22 8px,#125d3c 8px,#125d3c 16px);border-color:#e0f8ec;color:#e0f8ec}

    .name{font-weight:900}
    .you{color:#b6ffd6}
    .opp{color:#cfe8ff}
    .chip{padding:6px 12px;border-radius:999px;border:1px solid #1a704a;background:#0a3a22}
    .money{font-variant-numeric:tabular-nums}
    .controls{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:12px}
    .log{max-height:220px;overflow:auto;background:#072d1b;border-radius:12px;border:1px solid var(--line);padding:10px;font-size:13px}

    .sep{height:1px;background:var(--line);margin:8px 0}
    .hidden{display:none}
    @media (max-width: 1150px){main{grid-template-columns:1fr;}}
  </style>
</head>
<body>
  <header>
    <h1>Heads‑Up Poker <span class="tag">(enter the same code to link)</span></h1>
    <div class="row"><span class="pill" id="connStatus">Not connected</span></div>
  </header>

  <main>
    <!-- LEFT: One‑step join -->
    <section class="card section stack">
      <strong>Join / Host</strong>
      <div class="stack">
        <label>Display name<input id="nameInput" type="text" placeholder="Your name"/></label>
        <div class="row">
          <label class="grow">Game code<input id="codeInput" type="text" placeholder="e.g. POKER-7F3A"/></label>
          <button id="btnRndCode">Random</button>
        </div>
        <div class="row">
          <button id="btnJoin" class="primary">Enter game</button>
        </div>
        <small class="pill">First to enter claims the room as Host. Second joins as Guest. Powered by PeerJS Cloud.</small>
      </div>
    </section>

    <!-- MIDDLE: Table / Game -->
    <section class="card">
      <div class="section stack">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div class="row" style="gap:14px;align-items:center">
            <span class="name you" id="youName">You</span>
            <span class="chip">Bank: $<span class="money" id="youBank">1000</span></span>
            <span class="chip">Bet: $<span class="money" id="youBet">0</span></span>
          </div>
          <div class="row" style="gap:14px;align-items:center">
            <span class="name opp" id="oppName">Opponent</span>
            <span class="chip">Bank: $<span class="money" id="oppBank">1000</span></span>
            <span class="chip">Bet: $<span class="money" id="oppBet">0</span></span>
          </div>
        </div>
      </div>
      <div class="table section">
        <div class="rim"></div>
        <div class="pot">Hand <span id="handNo">1</span> • Street: <span id="street">Preflop</span> • Pot: $<span class="money" id="pot">0</span> • <span id="turnTag">Your</span> turn • Code: <span id="codeTag">—</span></div>
        <div class="board" id="board"></div>
        <div class="controls" id="controls">
          <button id="btnDeal" class="primary">Start / Next Hand</button>
          <button id="btnFold" class="warning hidden">Fold</button>
          <button id="btnCheck" class="hidden">Check / Call</button>
          <div id="betWrap" class="row hidden"><input id="betAmt" type="number" min="1" step="1" value="10" style="width:120px"><button id="btnBet">Bet / Raise</button></div>
          <button id="btnShowdown" class="hidden">Showdown</button>
        </div>
        <div class="center" style="margin-top:14px">
          <div class="hand" id="yourHand"></div>
          <div class="hand" id="oppHand"></div>
        </div>
      </div>
      <div class="section">
        <div class="log" id="log"></div>
      </div>
    </section>

    <!-- RIGHT: Settings / Names -->
    <section class="card section stack">
      <div class="stack">
        <div class="row">
          <label class="row">Small Blind $<input id="sb" type="number" min="1" value="5" style="width:100px"></label>
          <label class="row">Big Blind $<input id="bb" type="number" min="2" value="10" style="width:100px"></label>
        </div>
        <div class="row">
          <label class="row">Starting Bank $<input id="startBank" type="number" min="100" value="1000" style="width:120px"></label>
          <button id="applySettings">Apply</button>
        </div>
        <div class="sep"></div>
        <small class="pill">Deck shuffles are derived from the game code each hand so both sides stay in sync.</small>
      </div>
    </section>
  </main>

  <script>
  /********************
   * Helpers & UI
   ********************/
  const $ = s=>document.querySelector(s); const logEl=$('#log');
  function log(m){ logEl.innerHTML = `[${new Date().toLocaleTimeString()}] ${m}<br>` + logEl.innerHTML; }
  const statusEl=$('#connStatus'); function setStatus(s){ statusEl.textContent=s; }
  function randomCode(){ const a='ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; let s=''; for(let i=0;i<8;i++) s+=a[Math.floor(Math.random()*a.length)]; return `POKER-${s.match(/.{1,4}/g).join('-')}`; }
  $('#btnRndCode').onclick=()=>{ $('#codeInput').value=randomCode(); };

  // Cards
  const SUITS=['♠','♥','♦','♣']; const RANKS=['2','3','4','5','6','7','8','9','T','J','Q','K','A'];
  function makeDeck(){ const d=[]; for(const s of SUITS){ for(const r of RANKS){ d.push(r+s); } } return d; }
  function xorshift32(seed){ let x=seed>>>0; return ()=>{ x^=x<<13; x^=x>>>17; x^=x<<5; return (x>>>0)/0xffffffff; }; }
  function seededShuffle(seed, deck){ const rnd=xorshift32(seed); const a=deck.slice(); for(let i=a.length-1;i>0;i--){ const j=Math.floor(rnd()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
  function codeToSeed(code){ let h=2166136261>>>0; for(const ch of code){ h^=ch.charCodeAt(0); h=(h*16777619)>>>0; } return h; }
  function renderCard(code, dim=false){ const el=document.createElement('div'); el.className='card-ui'+(dim?' dim':''); el.textContent=code; return el; }

  // Hand evaluator
  const ranksMap = Object.fromEntries(RANKS.map((r,i)=>[r,i]));
  function evaluate7(cards){ const bySuit={'♠':[], '♥':[], '♦':[], '♣':[]}; const counts=new Map();
    for(const c of cards){ const r=c[0], s=c[1]; bySuit[s].push(r); counts.set(r,(counts.get(r)||0)+1); }
    const allRanks=cards.map(c=>ranksMap[c[0]]).sort((a,b)=>b-a);
    function straightValue(arr){ const u=[...new Set(arr)].sort((a,b)=>b-a); if(u.includes(12)) u.push(-1); let run=1, best=null; for(let i=0;i<u.length-1;i++){ if(u[i]-1===u[i+1]){ run++; if(run>=5) best=u[i-3]; } else run=1; } return best; }
    let flushSuit=null, flushRanks=null; for(const s of SUITS){ if(bySuit[s].length>=5){ flushSuit=s; flushRanks=bySuit[s].map(r=>ranksMap[r]).sort((a,b)=>b-a); break; } }
    const straightHigh=straightValue(allRanks);
    if(flushSuit){ const sr=bySuit[flushSuit].map(r=>ranksMap[r]).sort((a,b)=>b-a); const sh=straightValue(sr); if(sh!==null && sh!==undefined) return [8,sh]; }
    const groups=[...counts.entries()].map(([r,c])=>({rv:ranksMap[r],c})).sort((a,b)=> (b.c-a.c)||(b.rv-a.rv));
    if(groups[0]?.c===4){ const four=groups[0].rv; const k=Math.max(...allRanks.filter(v=>v!==four)); return [7,four,k]; }
    if(groups[0]?.c===3 && groups[1]?.c>=2) return [6,groups[0].rv,groups[1].rv];
    if(flushSuit) return [5,...flushRanks.slice(0,5)];
    if(straightHigh!==null && straightHigh!==undefined) return [4,straightHigh];
    if(groups[0]?.c===3){ const t=groups[0].rv; const ks=allRanks.filter(v=>v!==t).slice(0,2); return [3,t,...ks]; }
    if(groups[0]?.c===2 && groups[1]?.c===2){ const hi=Math.max(groups[0].rv,groups[1].rv), lo=Math.min(groups[0].rv,groups[1].rv); const k=allRanks.filter(v=>v!==hi && v!==lo)[0]; return [2,hi,lo,k]; }
    if(groups[0]?.c===2){ const p=groups[0].rv; const ks=allRanks.filter(v=>v!==p).slice(0,3); return [1,p,...ks]; }
    return [0,...allRanks.slice(0,5)]; }
  function compareRanks(a,b){ for(let i=0;i<Math.max(a.length,b.length);i++){ const av=a[i]??-1, bv=b[i]??-1; if(av!==bv) return av-bv; } return 0; }

  /********************
   * Game State
   ********************/
  let peer, conn, isHost=false, connected=false;
  let state={ code:'', handNo:1, street:'Preflop', dealer:0,
    players:[{name:'Host', bank:1000, bet:0, cards:[], folded:false},{name:'Guest', bank:1000, bet:0, cards:[], folded:false}],
    sb:5, bb:10, pot:0, board:[], turn:0, seed:1234, deck:[] };
  function youIndex(){ return isHost?0:1; } function oppIndex(){ return isHost?1:0; }
  function updateCodeTag(){ $('#codeTag').textContent = state.code || '—'; }

  function applySettings(){ state.sb=parseInt($('#sb').value)||5; state.bb=parseInt($('#bb').value)||10; const bk=parseInt($('#startBank').value)||1000; state.players[0].bank=bk; state.players[1].bank=bk; const nm=$('#nameInput').value|| (isHost?'Host':'Guest'); state.players[youIndex()].name=nm; send({t:'settings', sb:state.sb, bb:state.bb, bank:bk, name:nm}); render(); }
  $('#applySettings').onclick=applySettings;
  $('#nameInput').addEventListener('input', ()=>{ state.players[youIndex()].name=$('#nameInput').value|| (isHost?'Host':'Guest'); send({t:'name', name: state.players[youIndex()].name}); render(); });

  function resetBets(){ state.players.forEach(p=>p.bet=0); }
  function nextStreet(){ if(state.street==='Preflop'){ state.street='Flop'; state.board.push(state.deck.pop(),state.deck.pop(),state.deck.pop()); }
    else if(state.street==='Flop'){ state.street='Turn'; state.board.push(state.deck.pop()); }
    else if(state.street==='Turn'){ state.street='River'; state.board.push(state.deck.pop()); }
    else { state.street='Showdown'; }
    send({t:'street', street:state.street, board:state.board}); resetBets(); render(); }

  function startHand(){ if(!connected){ alert('Connect to your friend first.'); return; }
    state.handNo++; state.board=[]; state.pot=0; resetBets(); state.players.forEach(p=>{ p.cards=[]; p.folded=false; }); state.street='Preflop';
    if(isHost){ const nonce=(Math.random()*0xffffffff)>>>0; state.seed = codeToSeed((state.code||'POKER')+":"+nonce); send({t:'seed', seed:state.seed, handNo:state.handNo, dealer:state.dealer, sb:state.sb, bb:state.bb}); }
    state.deck=seededShuffle(state.seed, makeDeck());
    state.players[0].cards=[state.deck.pop(), state.deck.pop()]; state.players[1].cards=[state.deck.pop(), state.deck.pop()];
    const d=state.dealer, nd=1-d; postBlind(d,state.sb); postBlind(nd,state.bb); state.turn=d;
    send({t:'cards', you:isHost?state.players[1].cards:state.players[0].cards}); render(); }
  function postBlind(i,amt){ state.players[i].bank-=amt; state.players[i].bet+=amt; state.pot+=amt; }
  function toggleDealer(){ state.dealer = state.dealer?0:1; }

  function fold(){ const i=youIndex(); state.players[i].folded=true; const w=oppIndex(); log(`${state.players[i].name} folds. ${state.players[w].name} wins $${state.pot}.`); send({t:'fold'}); state.players[w].bank += state.pot; endHand(); }
  function checkCall(){ const i=youIndex(), o=oppIndex(); const needed=Math.max(0, state.players[o].bet - state.players[i].bet); if(needed>0){ if(state.players[i].bank<needed) return alert('Not enough chips'); state.players[i].bank-=needed; state.players[i].bet+=needed; state.pot+=needed; log(`${state.players[i].name} calls $${needed}.`); send({t:'call', amt:needed}); if(state.players[i].bet===state.players[o].bet){ nextStreet(); state.turn=state.dealer; render(); } }
    else { log(`${state.players[i].name} checks.`); send({t:'check'}); if(state.players[o].bet===0){ nextStreet(); state.turn=state.dealer; render(); } }
    flipTurn(); render(); }
  function betRaise(){ const i=youIndex(), o=oppIndex(); const amt=parseInt($('#betAmt').value)||0; if(amt<=0) return; const needed=Math.max(0, state.players[o].bet - state.players[i].bet); const total=needed+amt; if(state.players[i].bank<total) return alert('Not enough chips'); if(needed>0){ state.players[i].bank-=needed; state.players[i].bet+=needed; state.pot+=needed; } state.players[i].bank-=amt; state.players[i].bet+=amt; state.pot+=amt; log(`${state.players[i].name} bets/raises $${amt}.`); send({t:'bet', call:needed, raise:amt}); flipTurn(); render(); }
  function flipTurn(){ state.turn = state.turn?0:1; $('#turnTag').textContent = (state.turn===youIndex())? 'Your':'Their'; }

  function showdown(){ state.street='Showdown'; const p0=evaluate7([...state.players[0].cards,...state.board]); const p1=evaluate7([...state.players[1].cards,...state.board]); const cmp=compareRanks(p0,p1); let w = cmp>0?0:(cmp<0?1:-1); if(state.players[0].folded) w=1; if(state.players[1].folded) w=0; if(w===-1){ state.players[0].bank+=Math.floor(state.pot/2); state.players[1].bank+=Math.ceil(state.pot/2); log(`Showdown: split pot $${state.pot}.`); } else { state.players[w].bank+=state.pot; log(`Showdown: ${state.players[w].name} wins $${state.pot}.`); } send({t:'showdown'}); endHand(); }
  function endHand(){ state.pot=0; state.players.forEach(p=>p.bet=0); toggleDealer(); state.turn=state.dealer; render(); }

  // Buttons
  $('#btnDeal').onclick=startHand; $('#btnFold').onclick=fold; $('#btnCheck').onclick=checkCall; $('#btnBet').onclick=betRaise; $('#btnShowdown').onclick=showdown;
  $('#btnJoin').onclick=()=>{
    const code=$('#codeInput').value.trim(); if(!code) return alert('Enter a game code');
    state.code=code; updateCodeTag(); location.hash=encodeURIComponent(code); startPeerFlow(code);
  };

  /********************
   * PeerJS one‑code flow
   * First client to claim room becomes Host (ID = roomId)
   * If ID is taken, become Guest with random ID and connect to roomId
   ********************/
  function startPeerFlow(code){
    const roomId = `hu-${code}`;
    setStatus('Connecting…');
    // Try to be host
    let triedGuest=false;
    peer = new Peer(roomId, {host:'peerjs.com', port:443, secure:true});

    peer.on('open', (id)=>{ isHost=true; setStatus('Waiting for opponent…'); log('You are Host. Room: '+roomId); });

    peer.on('connection', (c)=>{ if(conn) return; conn=c; bindConn(); });

    peer.on('error', (e)=>{
      const msg=(e&&e.type)||''; if(!triedGuest && (msg==='unavailable-id' || (e.message||'').includes('ID is taken'))){
        // Become guest
        triedGuest=true; tryGuest(roomId);
      } else { console.error(e); alert('Connection error: '+(e.message||e)); setStatus('Error'); }
    });
  }
  function tryGuest(roomId){
    peer = new Peer(undefined, {host:'peerjs.com', port:443, secure:true});
    peer.on('open', ()=>{ isHost=false; setStatus('Joining…'); const c = peer.connect(roomId); c.on('open', ()=>{ conn=c; bindConn(); }); c.on('error', e=>{ alert('Join failed: '+(e.message||e)); setStatus('Error'); }); });
    peer.on('connection', ()=>{});
    peer.on('error', e=>{ console.error(e); setStatus('Error'); });
  }
  function bindConn(){ connected=true; setStatus('Connected'); log('P2P connected.');
    conn.on('data', m=>onMsg(m)); conn.on('close', ()=>{ connected=false; setStatus('Disconnected'); });
    // Say hello with your display name
    send({t:'hello', name: $('#nameInput').value||'Player'});
  }
  function send(obj){ if(conn && conn.open){ conn.send(obj); } }

  /********************
   * Incoming messages
   ********************/
  function onMsg(m){ switch(m.t){
    case 'hello': state.players[oppIndex()].name = m.name || 'Opponent'; render(); break;
    case 'settings': state.sb=m.sb; state.bb=m.bb; state.players[0].bank=m.bank; state.players[1].bank=m.bank; render(); break;
    case 'name': state.players[oppIndex()].name=m.name; render(); break;
    case 'seed': state.seed=m.seed; state.handNo=m.handNo; state.dealer=m.dealer; state.sb=m.sb; state.bb=m.bb; state.board=[]; state.pot=state.sb+state.bb; resetBets(); state.deck=seededShuffle(state.seed, makeDeck()); state.players[0].cards=[state.deck.pop(),state.deck.pop()]; state.players[1].cards=[state.deck.pop(),state.deck.pop()]; state.players[0].bet=(state.dealer===0?state.sb:state.bb); state.players[1].bet=(state.dealer===1?state.sb:state.bb); state.players[0].bank-=state.players[0].bet; state.players[1].bank-=state.players[1].bet; state.turn=state.dealer; state.street='Preflop'; render(); break;
    case 'cards': state.players[youIndex()].cards=m.you; render(); break;
    case 'street': state.street=m.street; state.board=m.board; resetBets(); render(); break;
    case 'fold': state.players[oppIndex()].folded=true; log(`${state.players[oppIndex()].name} folds. You win $${state.pot}.`); state.players[youIndex()].bank+=state.pot; endHand(); break;
    case 'call': state.players[oppIndex()].bank-=m.amt; state.players[oppIndex()].bet+=m.amt; state.pot+=m.amt; log(`${state.players[oppIndex()].name} calls $${m.amt}.`); if(state.players[youIndex()].bet===state.players[oppIndex()].bet){ nextStreet(); state.turn=state.dealer; } flipTurn(); render(); break;
    case 'check': log(`${state.players[oppIndex()].name} checks.`); if(state.players[youIndex()].bet===0){ nextStreet(); state.turn=state.dealer; } flipTurn(); render(); break;
    case 'bet': if(m.call>0){ state.players[oppIndex()].bank-=m.call; state.players[oppIndex()].bet+=m.call; state.pot+=m.call; } state.players[oppIndex()].bank-=m.raise; state.players[oppIndex()].bet+=m.raise; state.pot+=m.raise; log(`${state.players[oppIndex()].name} bets/raises $${m.raise}.`); flipTurn(); render(); break;
    case 'showdown': showdown(); break; }
  }

  /********************
   * Render
   ********************/
  function render(){ $('#youName').textContent=state.players[youIndex()].name + (isHost?' (Host)':''); $('#oppName').textContent=state.players[oppIndex()].name + (!isHost?' (Host)':''); $('#youBank').textContent=state.players[youIndex()].bank; $('#oppBank').textContent=state.players[oppIndex()].bank; $('#youBet').textContent=state.players[youIndex()].bet; $('#oppBet').textContent=state.players[oppIndex()].bet; $('#handNo').textContent=state.handNo; $('#street').textContent=state.street; $('#pot').textContent=state.pot; $('#turnTag').textContent=(state.turn===youIndex())?'Your':'Their'; updateCodeTag();
    const boardEl=$('#board'); boardEl.innerHTML=''; state.board.forEach(c=>boardEl.appendChild(renderCard(c)));
    const yh=$('#yourHand'); yh.innerHTML=''; state.players[youIndex()].cards.forEach(c=>yh.appendChild(renderCard(c)));
    const oh=$('#oppHand'); oh.innerHTML=''; if(state.street==='Showdown'){ state.players[oppIndex()].cards.forEach(c=>oh.appendChild(renderCard(c))); } else { state.players[oppIndex()].cards.forEach(_=>oh.appendChild((()=>{const e=document.createElement('div'); e.className='card-ui back'; e.textContent=''; return e;})())); }
    const yourTurn=state.turn===youIndex(); const inHand=state.board.length>0 || state.street==='Preflop'; $('#btnFold').classList.toggle('hidden', !yourTurn || !inHand || state.street==='Showdown'); $('#btnCheck').classList.toggle('hidden', !yourTurn || state.street==='Showdown'); $('#betWrap').classList.toggle('hidden', !yourTurn || state.street==='Showdown'); $('#btnShowdown').classList.toggle('hidden', !(state.street==='River' || state.street==='Showdown'));
  }

  // Auto-join if #CODE present
  window.addEventListener('load', ()=>{
    const hash=decodeURIComponent(location.hash.replace('#','')); if(hash){ $('#codeInput').value=hash; state.code=hash; updateCodeTag(); startPeerFlow(hash); }
  });
  </script>
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
</body>
</html>
